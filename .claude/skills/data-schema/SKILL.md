# Skill: Data Schema & Column Reference

Reference this skill when working with `data/loans.db`, writing SQL queries, building filters in the dashboard, or debugging data issues.

---

## Database Overview

- **File**: `data/loans.db` (SQLite)
- **Table**: `loans`
- **Source**: `accepted_2007_to_2018Q4.csv` (~2.2M raw loans with ~151 columns)
- **Snapshot date**: March 2019
- **Generated by**: `scripts/export_to_sqlite.py`
- **Column strategy**: Only ~27 raw columns are kept (whitelist approach) plus engineered columns from cleaning. This keeps the DB under ~200MB instead of 1GB+.

### Column Whitelist (kept from raw data)

```python
KEEP_COLUMNS = [
    # Identifiers & terms
    'id', 'loan_status', 'funded_amnt', 'int_rate', 'term', 'installment',
    'grade', 'sub_grade', 'purpose', 'addr_state', 'home_ownership', 'issue_d',
    'last_pymnt_d', 'next_pymnt_d', 'last_credit_pull_d',
    # Balances & payments
    'out_prncp', 'total_rec_prncp', 'total_rec_int', 'total_rec_late_fee',
    'last_pymnt_amnt', 'recoveries', 'collection_recovery_fee',
    # Credit & income
    'fico_range_high', 'fico_range_low', 'last_fico_range_high',
    'last_fico_range_low', 'dti', 'dti_joint', 'annual_inc', 'annual_inc_joint',
    'application_type',
]
```

All other columns (`url`, `desc`, `emp_title`, `title`, `zip_code`, `emp_length`, `revol_bal`, `revol_util`, `total_acc`, `open_acc`, `pub_rec`, `delinq_2yrs`, `verification_status`, `pymnt_plan`, etc.) are never referenced by any function, filter, or dashboard component and are dropped during export.

---

## Key Raw Columns

### Identifiers & Loan Terms

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| `id` | TEXT | Unique loan identifier | "1077501" |
| `funded_amnt` | REAL | Original funded amount ($) | 10000.0 |
| `term_months` | INTEGER | Loan term (36 or 60) | 36 |
| `int_rate` | REAL | Interest rate as **decimal** (cleaned from string) | 0.1078 |
| `installment` | REAL | Monthly payment amount ($) | 322.67 |
| `grade` | TEXT | LC credit grade | "B" |
| `sub_grade` | TEXT | LC sub-grade | "B3" |
| `issue_d` | TEXT/DATE | Loan origination date | "2016-10-01" |
| `purpose` | TEXT | Loan purpose | "debt_consolidation" |
| `addr_state` | TEXT | Borrower state (2-letter) | "CA" |
| `application_type` | TEXT | "Individual" or "Joint App" | "Individual" |

### Current Status & Balances

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| `loan_status` | TEXT | Current loan status | "Current" |
| `out_prncp` | REAL | Outstanding principal balance ($) | 6915.72 |
| `total_rec_prncp` | REAL | Total principal received ($) | 3084.28 |
| `total_rec_int` | REAL | Total interest received ($) | 1788.34 |
| `total_rec_late_fee` | REAL | Total late fees received ($) | 0.0 |
| `last_pymnt_amnt` | REAL | Last payment amount ($) | 322.67 |
| `last_pymnt_d` | TEXT/DATE | Last payment date | "2019-03-01" |
| `next_pymnt_d` | TEXT/DATE | Next payment due date | "2019-04-01" |
| `recoveries` | REAL | Post-charge-off recoveries ($) | 0.0 |
| `collection_recovery_fee` | REAL | Collection fees ($) | 0.0 |

### Credit Scores

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| `fico_range_high` | REAL | Original FICO high | 689.0 |
| `fico_range_low` | REAL | Original FICO low | 685.0 |
| `last_fico_range_high` | REAL | Most recent FICO high | 704.0 |
| `last_fico_range_low` | REAL | Most recent FICO low | 700.0 |

### Income & DTI

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| `annual_inc` | REAL | Borrower annual income ($) | 75000.0 |
| `annual_inc_joint` | REAL | Joint annual income (null if Individual) | NaN |
| `dti` | REAL | Debt-to-income ratio (%) | 18.5 |
| `dti_joint` | REAL | Joint DTI (null if Individual) | NaN |

---

## loan_status Values

This is the most important column for segmentation. All analysis branches on these values:

| Status | Meaning | Used In |
|--------|---------|---------|
| `Current` | Loan is performing, payments current | Cash flow projections (if March 2019 last payment), credit metrics, CPR calculation |
| `Fully Paid` | Loan paid off in full | CDR calculation (denominator), credit metrics |
| `Charged Off` | Loan defaulted, written off | CDR (numerator), loss severity, recovery rate |
| `Late (31-120 days)` | 31-120 days delinquent | Transition matrix, credit metrics |
| `Late (16-30 days)` | 16-30 days delinquent | Transition matrix, credit metrics |
| `In Grace Period` | 1-15 days past due | Transition matrix, credit metrics |
| `Default` | In default, not yet charged off | Transition matrix |
| `Does not meet the credit policy. Status:Fully Paid` | Legacy policy | Treated same as Fully Paid |
| `Does not meet the credit policy. Status:Charged Off` | Legacy policy | Treated same as Charged Off |

---

## Engineered Columns (added by `calc_amort()`)

These columns are added when `calc_amort(df)` is called on the cleaned data. They exist in the DataFrame at runtime but may or may not be in `loans.db` depending on whether the export script runs calc_amort before writing.

### Original Expected Schedule

| Column | Type | Description |
|--------|------|-------------|
| `original_fico` | REAL | Average of `fico_range_high` and `fico_range_low` |
| `latest_fico` | REAL | Average of `last_fico_range_high` and `last_fico_range_low` |
| `dti_clean` | REAL | `dti_joint` for joint apps, `dti` for individual |
| `term_months` | INT | Extracted from term string (e.g., " 36 months" → 36) |
| `orig_exp_monthly_payment` | REAL | Calculated PMT from funded_amnt, int_rate, term |
| `orig_exp_total_paid` | REAL | `orig_exp_monthly_payment × term_months` |
| `orig_exp_total_interest` | REAL | `orig_exp_total_paid - funded_amnt` |
| `orig_exp_payments_made` | INT | Months between `issue_d` and snapshot (Mar 2019) |
| `orig_exp_remaining_balance` | REAL | Theoretical balance after payments_made (amortization formula) |

### Last Payment Period Columns

| Column | Type | Description |
|--------|------|-------------|
| `last_pmt_beginning_balance` | REAL | Balance at start of last payment period |
| `last_pmt_ending_balance` | REAL | Balance at end of last payment period |
| `last_pmt_scheduled_principal` | REAL | Expected principal portion of payment |
| `last_pmt_scheduled_interest` | REAL | Expected interest portion of payment |
| `last_pmt_actual_principal` | REAL | Actual principal paid (from `total_rec_prncp` delta) |
| `last_pmt_unscheduled_principal` | REAL | Prepayment amount (actual - scheduled, if positive) |

### Next Payment Period Columns

| Column | Type | Description |
|--------|------|-------------|
| `next_pmt_beginning_balance` | REAL | Same as `last_pmt_ending_balance` |
| `next_pmt_scheduled_principal` | REAL | Expected principal for next period |
| `next_pmt_scheduled_interest` | REAL | Expected interest for next period |

### Updated Metrics

| Column | Type | Description |
|--------|------|-------------|
| `updated_remaining_term` | INT | `term_months - orig_exp_payments_made` |
| `updated_remaining_payments` | REAL | Remaining balance / monthly payment estimate |

### Flags

| Column | Type | Description |
|--------|------|-------------|
| `curr_paid_late1_flag` | INT (0/1) | 1 if loan is Current but was in Late (16-30) last period. Used in transition matrix cure tracking. |
| `issue_quarter` | TEXT | Vintage quarter, e.g., "2016Q4" |

---

## Strata Columns (Dashboard Filters)

These are the columns available for filtering in the Streamlit sidebar:

| Filter Label | Column | Widget Type | Values |
|-------------|--------|-------------|--------|
| Grade | `grade` | Multiselect | A, B, C, D, E, F, G |
| Sub Grade | `sub_grade` | Multiselect | A1-A5, B1-B5, ..., G1-G5 |
| Term | `term_months` | Multiselect | 36, 60 |
| Purpose | `purpose` | Multiselect | debt_consolidation, credit_card, home_improvement, ... |
| State | `addr_state` | Multiselect | 50 states + DC |
| Vintage | `issue_quarter` | Multiselect | 2007Q2 through 2018Q4 |
| Loan Status | `loan_status` | Multiselect | All status values above |

### Filter Logic

- Sidebar filters produce a WHERE clause applied to ALL tabs
- "Select All" is the default for every filter
- Filters are AND-combined (grade=B AND term=36 AND vintage=2018Q1)
- Tab 1 (Portfolio Analytics) uses ALL loans matching the filter
- Tab 2 (Cash Flow Projection) and Tab 3 (Scenario Analysis) further filter to Current loans with March 2019 `last_pymnt_d` for projections, but use ALL loans for CDR and loss severity

---

## Data Population Splits

Understanding which loans go into which calculation is critical:

### For Portfolio Analytics (Tab 1)

- **Stratification tables**: ALL loans matching sidebar filters
- **Credit metrics (`calculate_credit_metrics`)**: ALL loans matching sidebar filters
- **Performance metrics (`calculate_performance_metrics`)**: ALL loans matching sidebar filters (needs Charged Off for CDR, Current for CPR)
- **Transition matrix (`calculate_transition_matrix`)**: ALL loans matching sidebar filters

### For Cash Flow Projection (Tab 2) and Scenario Analysis (Tab 3)

- **CDR**: Computed from ALL loans in the filtered strata (need Charged Off in numerator, all in denominator)
- **CPR**: Computed from Current loans with `last_pymnt_d == '2019-03-01'` ONLY
- **Loss Severity**: Computed from Charged Off loans in the filtered strata
- **Pool characteristics (UPB, WAC, WAM, monthly_payment)**: Current loans with `last_pymnt_d == '2019-03-01'` ONLY
- **Cash flow projections**: Run on the pool defined by the pool characteristics above

### SQL Helpers

```sql
-- All loans in a vintage
SELECT * FROM loans WHERE issue_quarter = '2018Q1';

-- Current loans with March 2019 payment (cash flow population)
SELECT * FROM loans
WHERE issue_quarter = '2018Q1'
  AND loan_status = 'Current'
  AND last_pymnt_d = '2019-03-01';

-- Charged Off loans (for CDR and loss severity)
SELECT * FROM loans
WHERE issue_quarter = '2018Q1'
  AND loan_status = 'Charged Off';

-- Quick UPB check
SELECT SUM(out_prncp) as total_upb,
       COUNT(*) as loan_count,
       AVG(int_rate) as simple_avg_rate
FROM loans
WHERE issue_quarter = '2018Q1'
  AND loan_status = 'Current'
  AND last_pymnt_d = '2019-03-01';
```

---

## Common Data Gotchas

1. **`int_rate` format**: Stored as decimal (0.1078), NOT percentage (10.78). If you see rates > 1.0, the cleaning step failed.
2. **`term` vs `term_months`**: Raw data has `term` as string (" 36 months"). Cleaned data has `term_months` as integer (36).
3. **`last_pymnt_d` dates**: Some Current loans have February 2019 last payment instead of March. These should be excluded from cash flow projections (they may have just been processed late).
4. **`dti` for joint applications**: Use `dti_joint` when `application_type == 'Joint App'`, stored in `dti_clean`.
5. **Null `out_prncp`**: Should be 0 for Fully Paid loans, not null. Check during cleaning.
6. **`recoveries` > 0 for non-Charged Off loans**: Shouldn't happen but might — these get late fees set to 0 during cleaning.
7. **`issue_quarter` generation**: Created from `issue_d` via `pd.to_period('Q').astype(str)` — produces format like "2016Q4".
